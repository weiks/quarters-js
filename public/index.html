<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Quarters SDK Test</title>
  </head>
  <style media="screen">
  .buy-quarters-button {
    margin: 10px;
  }

  .loader {
    border: 3px solid black;
    border-top: 3px solid #CCC;
    border-radius: 50%;
    width: 25px;
    height: 25px;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }

    100% {
      transform: rotate(360deg);
    }
  }

  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.css">
  <script src="/Quarters.min.js" charset="utf-8"></script>
  <body>
    <div class="container">
      <div class="row">
        <div id="app">
        </div>
      </div>
      <div class="row">
        <a class="buy-quarters-button"
          data-widget-type="button"
          data-order-code="1"
          data-amount="20">
          Play with 20 Quarters
        </a>
        <a class="buy-quarters-button"
          data-widget-type="button"
          data-order-code="2"
          data-button-type="green"
          data-amount="5"
          data-button-size="large">
          Play with 5 Quarters
        </a>
        <a class="buy-quarters-button"
          data-widget-type="button"
          data-order-code="7"
          data-button-type="red"
          data-button-size="small"
          data-amount="100">
          Play with 100 Quarters
        </a>
        <button class="buy-quarters-button"
          data-widget-type="button"
          data-order-code="10"
          data-amount="2"
          data-button-type="green">
          Play with 2 Quarters
        </button>
      </div>
    </div>
  </body>
  <script
    src1="https://dev.pocketfulofquarters.com/embeds/button.js"
    src="http://localhost:3000/embeds/button.js"
    data-script-name="quarters-embeds"
    data-app-id="Lpk5sPrA7P59HFlN7obS"
    data-app-key="1s4x2v8h3b9ollw1pt2afj8knheamvmvv"
    charset="utf-8"></script>
  <script crossorigin src="https://unpkg.com/react@16/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@16/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <script type="text/babel">
// Widget callbacks
var receiveMessage = function(event) {
  if (event.origin !== 'https://dev.pocketfulofquarters.com') {
    return
  }

  var data = JSON.parse(event.data)
  if (data.error) {
    // data.message
  } else if (data.cancel) {
    // user canceled transfer
  } else {
    // data.txId => Ethereum transaction tx id
    // data.requestId => Request Id to get details about order (/v1/requests/:requestId)
  }
}
// receive message
window.addEventListener('message', receiveMessage, false)

const openPopup = (url, width = 850, height = 600) => {
  const left = (screen.width - width) / 2
  const top = (screen.height - height) / 4
  const params = `width=${width},height=${height},left=${left},top=${top}`
  return window.open(url, 'request-quarters', params)
}

// quarters example
const quarterOptions = {
  // appKey: 'quarters-sdk',
  // appSecret: 'quarter-123456',

  appKey: 'Lpk5sPrA7P59HFlN7obS',
  appSecret: '1s4x2v8h3b9ollw1pt2afj8knheamvmvv',
  quartersURL: 'http://localhost:3000',
  apiURL: 'http://localhost:8888/v1/'
  // quartersURL: 'https://dev.pocketfulofquarters.com',
  // apiURL: 'https://api.dev.pocketfulofquarters.com/v1/'
}
const quarters = new Quarters(quarterOptions)

// app
class App extends React.Component {
  constructor() {
    super()

    // state
    this.state = {
      refreshToken: null,
      loading: false,
      txId: null
    }
  }

  componentDidMount() {
    const refreshToken = window.localStorage.getItem(
      'quarters_sdk:refresh_token'
    )
    if (window.localStorage.getItem('quarters_sdk:refresh_token')) {
      this.setState({
        refreshToken: refreshToken,
        loading: true
      })

      // set it to quarters
      quarters.setRefreshToken(refreshToken).then(() => {
        this.setState({
          loading: false
        })

        // load user
        this.loadUser()
      })
    }
  }

  login = () => {
    this.setState({
      loading: true
    })

    // authorize with iframe
    quarters.authorize('iframe', data => {
      if (data.code) {
        quarters
          .setAuthCode(data.code)
          .then(response => {
            // set refresh token
            this.setState({
              refreshToken: response.refresh_token,
              loading: false
            })

            window.localStorage.setItem(
              'quarters_sdk:refresh_token',
              response.refresh_token
            )

            // load user
            this.loadUser()
          })
          .catch((e) => {
            console.log(e)
            this.setState({
              loading: false
            })
          })
      } else {
        this.setState({
          loading: false
        })
      }
    })
  }

  logout = () => {
    window.localStorage.removeItem('quarters_sdk:refresh_token')
    this.setState({
      refreshToken: null,
      user: null
    })
  }

  loadUser = () => {
    quarters.me().then(response => {
      this.setState({
        user: response
      })
    })
  }

  requestTokens = (tokens = 100) => {
    this.setState({
      loading: true
    })

    quarters
      .requestTransfer({
        tokens: tokens,
        description: 'Just to test SDK'
      })
      .then(t => {
        this.setState({
          loading: false,
          requestId: t.id
        })

        const url = `${quarterOptions.quartersURL}/requests/${t.id}`
        if (false) {
          const redirectURI = encodeURIComponent(
            `${location.protocol}//${location.host}${location.pathname}`
          )
          window.location = `${url}?redirect_uri=${redirectURI}`
        } else {
          let popupWindow = null

          // receive message from popup
          const receiveMessage = event => {
            if (event.origin !== quarterOptions.quartersURL) {
              return
            }

            if (popupWindow) {
              // close popup window
              try {
                popupWindow.close()
              } catch (e) {
                console.log(e)
              }
            }

            const data = JSON.parse(event.data)
            if (data.txId) {
              this.setState({
                txId: data.txId
              })
            } else if (data.error) {
              setTimeout(() => {
                alert(data.error)
              }, 100)
            }
          }
          window.addEventListener('message', receiveMessage, false)

          // open popup
          popupWindow = openPopup(url)
        }
      })
      .catch(() => {
        this.setState({
          loading: false
        })
      })
  }

  render() {
    if (this.state.loading) {
      return <div className="loader" />
    }

    if (!this.state.refreshToken) {
      return <button onClick={this.login}>Login</button>
    }

    let txDiv = null
    if (this.state.txId) {
      txDiv = <div>TX ID: {this.state.txId}</div>
    }

    const name = this.state.user ? this.state.user.displayName : null
    return (
      <div>
        <div className="container">
          <div className="row">
            <button onClick={this.logout}>logout</button>
            &nbsp; {name}
          </div>
        </div>
        <div className="container">
          <div className="row">
            <div className="one-half column">
              <button
                className="button-primary"
                onClick={this.requestTokens.bind(this, 20)}
              >
                Buy truck for 20 quarters
              </button>
            </div>
            <div className="one-half column">
              <button
                className="button-primary"
                onClick={this.requestTokens.bind(this, 100)}
              >
                Buy fighter plane for 100 quarters
              </button>
            </div>
          </div>
          {txDiv}
        </div>
      </div>
    )
  }
}

ReactDOM.render(<App />, document.getElementById('app'))
</script>
</html>
